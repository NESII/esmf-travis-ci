FROM bekozi/esmf-hdf5

#ENV BB_SANDBOX=${HOME}/sandbox
#ENV BB_MPICC=$BB_MPICH_PREFIX/bin/mpicc
#ENV BB_MPIF90=$BB_MPICH_PREFIX/bin/mpif90

ENV BB_NETCDFC_NAME=netcdf-c
ENV BB_NETCDFC_VER=4.7.3
ENV BB_NETCDFC_SANDBOX=${BB_SANDBOX}/${BB_NETCDFC_NAME}/${BB_NETCDFC_VER}
ENV BB_NETCDFC_GITDIR=${BB_NETCDFC_SANDBOX}/git
ENV BB_NETCDFC_SRCDIR=${BB_NETCDFC_SANDBOX}/src
ENV BB_NETCDFC_PREFIX=${BB_NETCDFC_SANDBOX}/install
ENV BB_NETCDFC_FILEPREFIX=${BB_NETCDFC_NAME}
ENV BB_NETCDFC_COMPRESSED=""
ENV BB_NETCDFC_URL=https://github.com/Unidata/netcdf-c.git
ENV BB_NETCDFC_APTPKGS=""

ENV BB_NETCDFF_NAME=netcdf-fortran
ENV BB_NETCDFF_VER=4.5.2
ENV BB_NETCDFF_SANDBOX=${BB_SANDBOX}/${BB_NETCDFF_NAME}/${BB_NETCDFF_VER}
ENV BB_NETCDFF_GITDIR=${BB_NETCDFF_SANDBOX}/git
ENV BB_NETCDFF_SRCDIR=${BB_NETCDFF_SANDBOX}/src
# Share directory for ESMF install
ENV BB_NETCDFF_PREFIX=${BB_NETCDFC_PREFIX}
ENV BB_NETCDFF_FILEPREFIX=${BB_NETCDFF_NAME}-${BB_NETCDFF_VER}
ENV BB_NETCDFF_COMPRESSED=${BB_NETCDFF_FILEPREFIX}.tar.gz
ENV BB_NETCDFF_URL=ftp://ftp.unidata.ucar.edu/pub/netcdf/${BB_NETCDFF_COMPRESSED}
ENV BB_NETCDFF_APTPKGS=""

# Netcdf-C =====================================================================

WORKDIR ${BB_NETCDFC_GITDIR}

RUN git clone ${BB_NETCDFC_URL}
WORKDIR ${BB_NETCDFC_NAME}
RUN git pull
RUN git checkout v${BB_NETCDFC_VER}

ENV CC=mpicc
ENV CFLAGS="-I${BB_HDF_PREFIX}/include -fPIC ${CFLAGS}"
ENV LDFLAGS="-L${BB_HDF_PREFIX}/lib ${LDFLAGS}"

RUN ./configure --enable-parallel-tests --prefix=${BB_NETCDFC_PREFIX}

RUN make
RUN make install

# Netcdf-Fortran ===============================================================

WORKDIR ${BB_NETCDFF_SRCDIR}
RUN wget ${BB_NETCDFF_URL}
RUN tar -xzvf ${BB_NETCDFF_COMPRESSED}
WORKDIR ${BB_NETCDFF_FILEPREFIX}

ENV FC=mpif90
ENV CFLAGS="-I${BB_NETCDFC_PREFIX}/include ${CFLAGS}"
ENV CPPFLAGS="-I${BB_NETCDFC_PREFIX}/lib ${CPPFLAGS}"
ENV LDFLAGS="-L${BB_NETCDFC_PREFIX}/lib ${LDFLAGS}"

RUN ./configure --prefix=${BB_NETCDFF_PREFIX}

RUN make
RUN make install
